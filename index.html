<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Santri - Pondok Al Inaaroh Alhikam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* CSS yang sudah ada */
        .islamic-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23065f46' fill-opacity='0.05'%3E%3Cpath d='M30 30c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20zm0 0c0 11.046 8.954 20 20 20s20-8.954 20-20-8.954-20-20-20-20 8.954-20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- Perubahan CSS untuk Animasi Warna-Warni --- */
        
        /* Animasi gradien untuk latar belakang */
        .bg-animated-gradient {
            /* Warna Baru: Lebih cerah dan beragam */
            background: linear-gradient(-45deg, #ff9933, #ff3366, #6633ff, #33ccff, #33ff99);
            background-size: 400% 400%; /* Penting untuk gerakan halus */
            animation: gradientAnimation 20s ease infinite; /* Durasi lebih panjang untuk kesan tenang */
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%; /* Mulai dari Kiri */
            }
            50% {
                background-position: 100% 50%; /* Pindah ke Kanan */
            }
            100% {
                background-position: 0% 50%; /* Kembali ke Kiri */
            }
        }

        /* Animasi pudar untuk kotak login */
        .fade-in-up {
            animation: fadeInUp 1s ease-in-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Efek hover untuk tombol */
        .hover-scale {
            transition: transform 0.3s ease;
        }

        .hover-scale:hover {
            transform: scale(1.02);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="min-h-screen bg-animated-gradient background: linear-gradient(-45deg, #ff9933, #ff3366, #6633ff, #33ccff, #33ff99);
            background-size: 400% 400%; /* Penting untuk gerakan halus */
            animation: gradientAnimation 20s ease infinite;">
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <img src="Gambar WhatsApp 2025-08-17 pukul 05.09.10_ea187ddd.jpg" alt="Logo Pondok" class="w-100 h-50 object-cover rounded-full border-4">
                </div>
                <h1 class="text-2xl font-bold text-emerald-800">Sistem Absensi Santri</h1>
                <p class="text-emerald-600 mt-2">Pondok Al-Inaaroh Al-Hikam</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="showRegister" class="text-emerald-600 hover:text-emerald-700 text-sm">
                    Belum punya akun? Daftar di sini
                </button>
            </div>
        </div>
    </div>

    <div id="registerPage" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-emerald-800">Daftar Akun Baru</h2>
                <p class="text-emerald-600 mt-2">Untuk Pengurus dan Tamu</p>
            </div>
            
            <form id="registerForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="regName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="regUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                     <input 
                            type="password" 
                            id="regPassword" 
                            required 
                            minlength="5" 
                            maxlength="8" 
                            pattern="\d{5,8}" 
                            title="Password harus berupa 5-8 angka" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="regRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Pilih Role</option>
                        <option value="pengurus">Pengurus</option>
                        <option value="Tamu">Tamu</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                    Daftar
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="showLogin" class="text-emerald-600 hover:text-emerald-700 text-sm">
                    Sudah punya akun? Masuk di sini
                </button>
            </div>
        </div>
    </div>

    <div id="dashboardPage" class="min-h-screen hidden">
        <header class="bg-white shadow-lg border-b border-emerald-100">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="w-11 h-11 bg-emerald-600 rounded-full flex items-center justify-center mr-3">
                            <img src="Gambar WhatsApp 2025-08-17 pukul 05.09.10_ea187ddd.jpg" alt="Logo Pondok" class="w-100 h-50 object-cover rounded-full">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-emerald-800">Absensi Santri</h1>
                            <p class="text-sm text-emerald-600">Pondok Al Inaaroh Alhikam</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-emerald-700 font-medium"></span>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="adminPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <h2 class="text-xl font-bold text-emerald-800 mb-4">Daftar Pengguna</h2>
                    
                    <div id="usersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="showPage('registerPage')" class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                            <i class="fas fa-plus mr-2"></i> Tambah Akun Baru
                        </button>
                    </div>
                </div>
            </div>

            <div id="activityPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <h2 class="text-xl font-bold text-emerald-800 mb-4">Pilih Jenis Kegiatan</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="activity-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-200" data-activity="sekolah">
                            <div class="text-2xl mb-2"><i class="fas fa-book-reader"></i></div>
                            <div class="font-medium">Sekolah</div>
                        </button>
                        <button class="activity-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-200" data-activity="absen kamar">
                            <div class="text-2xl mb-2"><i class="fas fa-bed"></i></div>
                            <div class="font-medium">Absen Kamar</div>
                        </button>
                        <button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah subuh">
                            <div class="text-2xl mb-2"><i class="fas fa-mosque"></i></div>
                            <div class="font-medium">Jamaah Subuh</div>
                        </button>
                        <button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah Ashar">
                            <div class="text-2xl mb-2"><i class="fas fa-mosque"></i></div>
                            <div class="font-medium">Jamaah Ashar</div>
                        </button><button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah magrib">
                            <div class="text-2xl mb-2"><i class="fas fa-mosque"></i></div>
                            <div class="font-medium">Jamaah Magrib</div>
                        </button><button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah Isya">
                            <div class="text-2xl mb-2"><i class="fas fa-mosque"></i></div>
                            <div class="font-medium">Jamaah Isya</div>
                        </button>
                        <button class="activity-btn bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition duration-200" data-activity="piket">
                            <div class="text-2xl mb-2"><i class="fas fa-broom"></i></div>
                            <div class="font-medium">Piket</div>
                        </button>
                        <button class="activity-btn bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition duration-200" data-activity="roan">
                            <div class="text-2xl mb-2"><i class="fas fa-hammer"></i></div>
                            <div class="font-medium">Roan/Kerjabakti</div>
                        </button>
                    </div>
                </div>
            </div>

            <div id="scannerPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-emerald-800">Scanner QR Code</h2>
                        <div class="text-sm text-emerald-600">
                            Kegiatan: <span id="selectedActivity" class="font-medium"></span>
                        </div>
                    </div>
                    
                    <div class="max-w-md mx-auto">
                        <div id="qr-reader" class="border-2 border-emerald-300 rounded-lg overflow-hidden"></div>
                        <div id="scanResult" class="mt-4 p-4 rounded-lg hidden">
                            <div id="scanMessage" class="text-center font-medium"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button id="backToActivity" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                            Kembali ke Pilihan Kegiatan
                        </button>
                    </div>
                </div>
            </div>

            <div id="recordsPanel" class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                <h2 class="text-xl font-bold text-emerald-800 mb-4">Data Absensi Hari Ini</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-emerald-50">
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Nama</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">NIS/ID</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Kegiatan</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Status</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-800">Edit User</h2>
            </div>
            
            <form id="editUserForm" class="space-y-6">
                <input type="hidden" id="editUsername">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="editName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="editUsernameField" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                    <input type="password" id="editPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="editRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="pengurus">Pengurus</option>
                        <option value="pelihat">Pelihat</option>
                    </select>
                </div>
                
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                        Simpan Perubahan
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator', registeredAt: new Date().toISOString() }
        ];
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let currentUser = null;
        let selectedActivity = null;
        let html5QrCode = null;

        // Google Apps Script Web App URL - GANTI DENGAN URL ANDA
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyws0adYm77AlBhtPky70fa8DIEUbBH1Tgif0H-olFCFciVEXdCXPmbxp_VUa-5mHu4/exec';

        // Sample santri data (in real app, this would come from database)
        const santriData = {
            '12345': { name: 'Ahmad Fauzi', nis: '12345' },
            '12346': { name: 'Muhammad Rizki', nis: '12346' },
            '12347': { name: 'Abdul Rahman', nis: '12347' },
            '12348': { name: 'Umar Faruq', nis: '12348' },
            '12349': { name: 'Ali Hassan', nis: '12349' },
            '12350': { name: 'Afrizal', nis: '12350' }
        };

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('[id$="Page"]').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `${user.name} (${user.role})`;
                showDashboard();
            } else {
                alert('Username atau password salah!');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            
            if (users.find(u => u.username === username)) {
                alert('Username sudah digunakan!');
                return;
            }
            
            const newUser = {
                username,
                password,
                role,
                name,
                registeredAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            // Send user data to spreadsheet
            sendUserToSpreadsheet(newUser);
            
            alert('Akun berhasil dibuat! Silakan login.');
            showPage('loginPage');
            document.getElementById('registerForm').reset();
        });

        // Show/Hide Register
        document.getElementById('showRegister').addEventListener('click', () => showPage('registerPage'));
        document.getElementById('showLogin').addEventListener('click', () => showPage('loginPage'));

        // Dashboard
        function showDashboard() {
            showPage('dashboardPage');
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadUsersList();
            } else if (currentUser.role === 'pengurus') {
                document.getElementById('activityPanel').classList.remove('hidden');
            }
            
            loadAttendanceRecords();
        }

        // Admin Panel - Diubah menjadi tampilan card
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            users.filter(u => u.role !== 'admin').forEach(user => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200 flex flex-col justify-between hover:shadow-md transition-shadow duration-200';
                
                const roleColor = user.role === 'pengurus' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                
                card.innerHTML = `
                    <div>
                        <div class="flex items-center mb-2">
                            <span class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700 text-xl mr-3">
                                ${user.name.charAt(0).toUpperCase()}
                            </span>
                            <div>
                                <h3 class="font-bold text-gray-800">${user.name}</h3>
                                <p class="text-sm text-gray-600">${user.username}</p>
                            </div>
                        </div>
                        <div class="space-y-1 text-sm text-gray-600">
                            <p><strong>Role:</strong> <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColor}">${user.role}</span></p>
                            <p><strong>Tanggal Daftar:</strong> ${new Date(user.registeredAt).toLocaleDateString('id-ID')}</p>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editUser('${user.username}')" class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600 transition duration-200">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deleteUser('${user.username}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-600 transition duration-200">
                            <i class="fas fa-trash-alt"></i> Hapus
                        </button>
                    </div>
                `;
                usersList.appendChild(card);
            });
        }

        // Activity Selection
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedActivity = this.dataset.activity;
                document.getElementById('selectedActivity').textContent = this.textContent.trim();
                document.getElementById('activityPanel').classList.add('hidden');
                document.getElementById('scannerPanel').classList.remove('hidden');
                startQRScanner();
            });
        });

        document.getElementById('backToActivity').addEventListener('click', function() {
            stopQRScanner();
            document.getElementById('scannerPanel').classList.add('hidden');
            document.getElementById('activityPanel').classList.remove('hidden');
            selectedActivity = null;
        });

        // QR Scanner
        function startQRScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    processQRCode(decodedText);
                },
                (errorMessage) => {
                    // Handle scan error silently
                }
            ).catch(err => {
                console.error("Error starting QR scanner:", err);
                alert("Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.");
            });
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => {
                    console.error("Error stopping QR scanner:", err);
                });
            }
        }

        function processQRCode(qrData) {
            const santri = santriData[qrData];
            const today = new Date().toDateString();
            const now = new Date();
            
            if (!santri) {
                showScanResult('QR Code tidak valid!', 'error');
                return;
            }
            
            // Check if already scanned for this activity today
            const existingRecord = attendanceData.find(record => 
                record.nis === santri.nis && 
                record.activity === selectedActivity && 
                new Date(record.timestamp).toDateString() === today
            );
            
            if (existingRecord) {
                showScanResult(`${santri.name} sudah absen untuk kegiatan ${selectedActivity} hari ini!`, 'warning');
                return;
            }
            
            // Add attendance record
            const attendanceRecord = {
                name: santri.name,
                nis: santri.nis,
                activity: selectedActivity,
                status: 'Hadir',
                timestamp: now.toISOString(),
                recordedBy: currentUser.name
            };
            
            attendanceData.push(attendanceRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Send to Google Spreadsheet
            sendToSpreadsheet(attendanceRecord);
            
            showScanResult(`âœ… ${santri.name} berhasil absen untuk ${selectedActivity}!`, 'success');
            loadAttendanceRecords();
        }

        function showScanResult(message, type) {
            const resultDiv = document.getElementById('scanResult');
            const messageDiv = document.getElementById('scanMessage');
            
            resultDiv.className = `mt-4 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 border border-green-300' :
                type === 'warning' ? 'bg-yellow-100 border border-yellow-300' :
                'bg-red-100 border border-red-300'
            }`;
            
            messageDiv.className = `text-center font-medium ${
                type === 'success' ? 'text-green-800' :
                type === 'warning' ? 'text-yellow-800' :
                'text-red-800'
            }`;
            
            messageDiv.textContent = message;
            resultDiv.classList.remove('hidden');
            
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 3000);
        }

        // Attendance Records
        function loadAttendanceRecords() {
            const attendanceList = document.getElementById('attendanceList');
            const today = new Date().toDateString();
            
            const todayRecords = attendanceData.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );
            
            attendanceList.innerHTML = '';
            
            if (todayRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        Belum ada data absensi hari ini
                    </td>
                `;
                attendanceList.appendChild(row);
                return;
            }
            
            todayRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                row.innerHTML = `
                    <td class="px-4 py-3">${record.name}</td>
                    <td class="px-4 py-3">${record.nis}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${record.activity}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${record.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">${new Date(record.timestamp).toLocaleTimeString('id-ID')}</td>
                `;
                attendanceList.appendChild(row);
            });
        }

        // Google Spreadsheet Functions
        async function sendToSpreadsheet(data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addAttendance',
                        data: data
                    })
                });
                
                console.log('Data berhasil dikirim ke spreadsheet');
            } catch (error) {
                console.error('Error mengirim data ke spreadsheet:', error);
                // Data tetap tersimpan lokal meskipun gagal kirim ke spreadsheet
            }
        }

        async function sendUserToSpreadsheet(userData) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addUser',
                        data: userData
                    })
                });
                
                console.log('Data user berhasil dikirim ke spreadsheet');
            } catch (error) {
                console.error('Error mengirim data user ke spreadsheet:', error);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Yakin ingin logout?')) {
                stopQRScanner();
                currentUser = null;
                selectedActivity = null;
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('activityPanel').classList.add('hidden');
                document.getElementById('scannerPanel').classList.add('hidden');
                showPage('loginPage');
                document.getElementById('loginForm').reset();
            }
        });

        // User Management Functions
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editName').value = user.name;
            document.getElementById('editUsernameField').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = user.role;
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
        }

        function deleteUser(username) {
            if (confirm(`Yakin ingin menghapus user "${username}"?`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('users', JSON.stringify(users));
                loadUsersList();
                alert(`User "${username}" berhasil dihapus.`);
                sendUserToSpreadsheet({ username, action: 'delete' });
            }
        }

        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const originalUsername = document.getElementById('editUsername').value;
            const newName = document.getElementById('editName').value;
            const newUsername = document.getElementById('editUsernameField').value;
            const newPassword = document.getElementById('editPassword').value;
            const newRole = document.getElementById('editRole').value;

            const userIndex = users.findIndex(u => u.username === originalUsername);
            if (userIndex !== -1) {
                users[userIndex].name = newName;
                users[userIndex].username = newUsername;
                users[userIndex].role = newRole;
                if (newPassword) {
                    users[userIndex].password = newPassword;
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                closeEditModal();
                loadUsersList();
                alert('User berhasil diubah!');
                sendUserToSpreadsheet({ 
                    originalUsername, 
                    newName, 
                    newUsername, 
                    newRole, 
                    newPassword: newPassword || 'unchanged' ,
                    action: 'edit'
                });
            }
        });
        
        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if there is an active user session in localStorage (optional)
            // For this simple app, we just show the login page
            showPage('loginPage');
        });
    </script>
</body>
</html>
