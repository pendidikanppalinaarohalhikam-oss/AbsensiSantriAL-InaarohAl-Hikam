<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Santri - Pondok Al Inaaroh Alhikam</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        .islamic-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23065f46' fill-opacity='0.05'%3E%3Cpath d='M30 30c0-11.046-8.954-20-20-20s-20 8.954-20 20 8.954 20 20 20 20-8.954 20-20zm0 0c0 11.046 8.954 20 20 20s20-8.954 20-20-8.954-20-20-20-20 8.954-20 20z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-500 via-emerald-200 to-green-400 islamic-pattern">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <img src="Gambar WhatsApp 2025-08-17 pukul 05.09.10_f173c3f4.jpg" alt="Logo Pondok" class="w-100 h-50 object-cover rounded-full border-4">
                </div>
                <h1 class="text-2xl font-bold text-emerald-800">Sistem Absensi Santri</h1>
                <p class="text-emerald-600 mt-2">Pondok Al-Inaaroh Al-Hikam</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="showRegister" class="text-emerald-600 hover:text-emerald-700 text-sm">
                    Belum punya akun? Daftar di sini
                </button>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-emerald-800">Daftar Akun Baru</h2>
                <p class="text-emerald-600 mt-2">Untuk Pengurus dan Tamu</p>
            </div>
            
            <form id="registerForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="regName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="regUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                     <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                     <input 
                            type="password" 
                            id="regPassword" 
                            required 
                            minlength="5" 
                            maxlength="8" 
                            pattern="\d{5,8}" 
                            title="Password harus berupa 5-8 angka" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="regRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Pilih Role</option>
                        <option value="pengurus">Pengurus</option>
                        <option value="Tamu">Tamu</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                    Daftar
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button id="showLogin" class="text-emerald-600 hover:text-emerald-700 text-sm">
                    Sudah punya akun? Masuk di sini
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="min-h-screen hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-emerald-100">
            <div class="max-w-7x1 mx-auto px-4 sm:px-7 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="w-11 h-11 bg-emerald-600 rounded-full flex items-center justify-center mr-3">
                            <img src="Gambar WhatsApp 2025-08-17 pukul 05.09.10_f173c3f4.jpg" alt="Logo Pondok" class="w-100 h-50 object-cover rounded-full">
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-emerald-800">Absensi Santri</h1>
                            <p class="text-sm text-emerald-600">Pondok Al Inaaroh Alhikam</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userInfo" class="text-emerald-700 font-medium"></span>
                        <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Panel -->
            <div id="adminPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <h2 class="text-xl font-bold text-emerald-800 mb-4">Daftar Pengguna</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-emerald-50">
                                    <th class="px-4 py-3 text-left text-emerald-800 font-medium">Nama</th>
                                    <th class="px-4 py-3 text-left text-emerald-800 font-medium">Username</th>
                                    <th class="px-4 py-3 text-left text-emerald-800 font-medium">Role</th>
                                    <th class="px-4 py-3 text-left text-emerald-800 font-medium">Tanggal Daftar</th>
                                    <th class="px-4 py-3 text-left text-emerald-800 font-medium">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="usersList">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Activity Selection (Pengurus Only) -->
            <div id="activityPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <h2 class="text-xl font-bold text-emerald-800 mb-4">Pilih Jenis Kegiatan</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="activity-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-200" data-activity="sekolah">
                            <div class="text-2xl mb-2">ðŸ“š</div>
                            <div class="font-medium">Sekolah</div>
                        </button>
                        <button class="activity-btn bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-200" data-activity="absen kamar">
                            <div class="text-2xl mb-2">ðŸ“š</div>
                            <div class="font-medium">Absen Kamar</div>
                        </button>
                        <button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah subuh">
                            <div class="text-2xl mb-2">ðŸ•Œ</div>
                            <div class="font-medium">Jamaah subuh</div>
                        </button>
                        <button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah Ashar">
                            <div class="text-2xl mb-2">ðŸ•Œ</div>
                            <div class="font-medium">Jamaah Ashar</div>
                        </button><button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah magrib">
                            <div class="text-2xl mb-2">ðŸ•Œ</div>
                            <div class="font-medium">Jamaah Magrib</div>
                        </button><button class="activity-btn bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-200" data-activity="jamaah Isya">
                            <div class="text-2xl mb-2">ðŸ•Œ</div>
                            <div class="font-medium">Jamaah Isya</div>
                        </button>
                        <button class="activity-btn bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition duration-200" data-activity="piket">
                            <div class="text-2xl mb-2">ðŸ§¹</div>
                            <div class="font-medium">Piket</div>
                        </button>
                        <button class="activity-btn bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition duration-200" data-activity="roan">
                            <div class="text-2xl mb-2">ðŸ”¨</div>
                            <div class="font-medium">Roan/Kerjabakti</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR Scanner -->
            <div id="scannerPanel" class="hidden mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-emerald-800">Scanner QR Code</h2>
                        <div class="text-sm text-emerald-600">
                            Kegiatan: <span id="selectedActivity" class="font-medium"></span>
                        </div>
                    </div>
                    
                    <div class="max-w-md mx-auto">
                        <div id="qr-reader" class="border-2 border-emerald-300 rounded-lg overflow-hidden"></div>
                        <div id="scanResult" class="mt-4 p-4 rounded-lg hidden">
                            <div id="scanMessage" class="text-center font-medium"></div>
                        </div>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button id="backToActivity" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                            Kembali ke Pilihan Kegiatan
                        </button>
                    </div>
                </div>
            </div>

            <!-- Attendance Records -->
            <div id="recordsPanel" class="bg-white rounded-xl shadow-lg p-6 border border-emerald-100">
                <h2 class="text-xl font-bold text-emerald-800 mb-4">Data Absensi Hari Ini</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-emerald-50">
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Nama</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">NIS/ID</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Kegiatan</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Status</th>
                                <th class="px-4 py-3 text-left text-emerald-800 font-medium">Waktu</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border border-emerald-100">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-emerald-800">Edit User</h2>
            </div>
            
            <form id="editUserForm" class="space-y-6">
                <input type="hidden" id="editUsername">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="editName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="editUsernameField" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password Baru (kosongkan jika tidak ingin mengubah)</label>
                    <input type="password" id="editPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="editRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="pengurus">Pengurus</option>
                        <option value="pelihat">Pelihat</option>
                    </select>
                </div>
                
                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-emerald-600 text-white py-3 rounded-lg hover:bg-emerald-700 transition duration-200 font-medium">
                        Simpan Perubahan
                    </button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let users = JSON.parse(localStorage.getItem('users')) || [
            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator', registeredAt: new Date().toISOString() }
        ];
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || [];
        let currentUser = null;
        let selectedActivity = null;
        let html5QrCode = null;

        // Google Apps Script Web App URL - GANTI DENGAN URL ANDA
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyws0adYm77AlBhtPky70fa8DIEUbBH1Tgif0H-olFCFciVEXdCXPmbxp_VUa-5mHu4/exec';

        // Sample santri data (in real app, this would come from database)
        const santriData = {
            'ID-1230': { name: 'Ahmad Wildanul Maryansyah', nis: 'ID-1230' },
            'ID-1231': { name: 'Abdullah Ghauts Assiroji', nis: 'ID-1231' },
            'ID-1232': { name: 'Achmad Farid', nis: 'ID-1232' },
            'ID-1233': { name: 'Ade Firmansyah', nis: 'ID-1233' },
            'ID-1234': { name: 'Ade Inayatullah', nis: 'ID-1234' },
            'ID-1235': { name: 'Adha Ananda Salam', nis: 'ID-1235' },
            'ID-1236': { name: 'Adib Rofiuddin', nis: 'ID-1236' },
            'ID-1237': { name: 'Ahmad Addin Alhaq', nis: 'ID-1237' },
            'ID-1238': { name: 'Ahmad Ali Haikal', nis: 'ID-1238' },
            'ID-1239': { name: 'Ahmad Azka Rachman', nis: 'ID-1239' },
            'ID-12310': { name: 'Ahmad Baihaqi', nis: 'ID-12310' },
            'ID-12311': { name: 'Ahmad Baihaqi', nis: 'ID-12311' },
            'ID-12312': { name: 'Ahmad Baliya', nis: 'ID-12312' },
            'ID-12313': { name: 'Ahmad Dafiansyah', nis: 'ID-12313' },
            'ID-12314': { name: 'Ahmad Dwi Sugiarto', nis: 'ID-12314' },
            'ID-12315': { name: 'Ahmad Fahmi Afrizal', nis: 'ID-12315' },
            'ID-12316': { name: 'Ahmad Faisal', nis: 'ID-12316' },
            'ID-12317': { name: 'Ahmad Faisal irfani', nis: 'ID-12317' },
            'ID-12318': { name: 'Ahmad Fajar', nis: 'ID-12318' },
            'ID-12319': { name: 'Ahmad Faruq Izzuddin', nis: 'ID-12319' },
            'ID-12320': { name: 'Ahmad Labib Irfany', nis: 'ID-12320' },
            'ID-12321': { name: 'Ahmad Miftakhul Ilmi', nis: 'ID-12321' },
            'ID-12322': { name: 'Ahmad Naelul Author', nis: 'ID-12322' },
            'ID-12323': { name: 'Ahmad Ramadani Sidik', nis: 'ID-12323' },
            'ID-12324': { name: 'Ahmad Zaenul Faqih', nis: 'ID-12324' },
            'ID-12325': { name: 'Ahmad Zanjabil', nis: 'ID-12325' },
            'ID-12326': { name: 'Ahsan Haris Maulana', nis: 'ID-12326' },
            'ID-12327': { name: 'Akmal Zaki Ilham', nis: 'ID-12327' },
            'ID-12328': { name: 'Aldo Hartanto', nis: 'ID-12328' },
            'ID-12329': { name: 'Anton Amar Albara', nis: 'ID-12329' },
            'ID-12330': { name: 'Anwar Maulana', nis: 'ID-12330' },
            'ID-12331': { name: 'Aprisal Aditia', nis: 'ID-12331' },
            'ID-12332': { name: 'Arman Al-Rasyidi', nis: 'ID-12332' },
            'ID-12333': { name: 'Arrafa Okta Pratama', nis: 'ID-12333' },
            'ID-12334': { name: 'Azriel Afdhal', nis: 'ID-12334' },
            'ID-12335': { name: 'Badar Muhammad Badruduja', nis: 'ID-12335' },
            'ID-12336': { name: 'Bagus Ariffianto', nis: 'ID-12336' },
            'ID-12337': { name: 'Bunyamin', nis: 'ID-12337' },
            'ID-12338': { name: 'Cahya Kurniawan', nis: 'ID-12338' },
            'ID-12339': { name: 'Choirul Huda Alfarizi', nis: 'ID-12339' },
            'ID-12340': { name: 'Daffa Meydi Khadafi', nis: 'ID-12340' },
            'ID-12341': { name: 'Fachri Akbar', nis: 'ID-12341' },
            'ID-12342': { name: 'Fachrul Anam', nis: 'ID-12342' },
            'ID-12343': { name: 'Facrul Fanani', nis: 'ID-12343' },
            'ID-12344': { name: 'Faiq Rausyan', nis: 'ID-12344' },
            'ID-12345': { name: 'Fakhri Firman Alhudha', nis: 'ID-12345' },
            'ID-12346': { name: 'Faqih Faizul Haq', nis: 'ID-12346' },
            'ID-12347': { name: 'Farel Al Aydrus', nis: 'ID-12347' },
            'ID-12348': { name: 'Fatih Barnanaj Hikam', nis: 'ID-12348' },
            'ID-12349': { name: 'Fatih Fauzan', nis: 'ID-12349' },
            'ID-12350': { name: 'Fayyad zildjian', nis: 'ID-12350' },
            'ID-12351': { name: 'Faza Dihyaulhaq Maulana', nis: 'ID-12351' },
            'ID-12352': { name: 'Gani Trimansyah', nis: 'ID-12352' },
            'ID-12353': { name: 'Gherry Al Khodri', nis: 'ID-12353' },
            'ID-12354': { name: 'Gibran Fahrama Rizal', nis: 'ID-12354' },
            'ID-12355': { name: 'Guinandra Ario', nis: 'ID-12355' },
            'ID-12356': { name: 'Haidzar rafie Abdullah', nis: 'ID-12356' },
            'ID-12357': { name: 'Hanif abidin', nis: 'ID-12357' },
            'ID-12358': { name: 'Hasan Jamaludin', nis: 'ID-12358' },
            'ID-12359': { name: 'Ibnu Bagus Mulyana', nis: 'ID-12359' },
            'ID-12360': { name: 'Ilham Syafiq Aldiansyah', nis: 'ID-12360' },
            'ID-12361': { name: 'Imam Syakib', nis: 'ID-12361' },
            'ID-12362': { name: 'Iqbal Maulana Yusuf', nis: 'ID-12362' },
            'ID-12363': { name: 'Irsyahruddin', nis: 'ID-12363' },
            'ID-12364': { name: 'Ismetullah', nis: 'ID-12364' },
            'ID-12365': { name: 'Jajat Jatnika', nis: 'ID-12365' },
            'ID-12366': { name: 'Kenang Budi Syahputra', nis: 'ID-12366' },
            'ID-12367': { name: 'Khaeran Shodiq', nis: 'ID-12367' },
            'ID-12368': { name: 'Khoerul Muhsinin', nis: 'ID-12368' },
            'ID-12369': { name: 'Luthfi Arthawan', nis: 'ID-12369' },
            'ID-12370': { name: 'Muhammad arifin Ilham', nis: 'ID-12370' },
            'ID-12371': { name: 'Muhammad Fadlan Ardiansyah', nis: 'ID-12371' },
            'ID-12372': { name: 'Muhammad Gilang Rabbani', nis: 'ID-12372' },
            'ID-12373': { name: 'Muhammad Nubhan Irfany', nis: 'ID-12373' },
            'ID-12374': { name: 'Muhammad Rusli Hadi', nis: 'ID-12374' },
            'ID-12375': { name: 'Muhammad Gilang Al fatih', nis: 'ID-12375' },
            'ID-12376': { name: 'Maulana Yusuf', nis: 'ID-12376' },
            'ID-12377': { name: 'Mohamed Syerhabil Zeelias Zidane Darmawan', nis: 'ID-12377' },
            'ID-12378': { name: 'Muhammad Abdul Ghani', nis: 'ID-12378' },
            'ID-12379': { name: 'Muhammad Abi Yahya', nis: 'ID-12379' },
            'ID-12380': { name: 'Muhammad Afrizal', nis: 'ID-12380' },
            'ID-12381': { name: 'Muhammad Alwi', nis: 'ID-12381' },
            'ID-12382': { name: 'Muhammad Arif Bilhaq', nis: 'ID-12382' },
            'ID-12383': { name: 'Muhammad Arif Dzul Ilmi', nis: 'ID-12383' },
            'ID-12384': { name: 'Muhammad Arkan Alzena', nis: 'ID-12384' },
            'ID-12385': { name: 'Muhammad Azmi Pahlevi', nis: 'ID-12385' },
            'ID-12386': { name: 'Muhammad Dany Suganda', nis: 'ID-12386' },
            'ID-12387': { name: 'Muhammad Diyauddin F', nis: 'ID-12387' },
            'ID-12388': { name: 'Muhammad Djaki Pratama', nis: 'ID-12388' },
            'ID-12389': { name: 'Muhammad Fachry', nis: 'ID-12389' },
            'ID-12390': { name: 'Muhammad Faqih', nis: 'ID-12390' },
            'ID-12391': { name: 'Muhammad Fitrah Al Farisi', nis: 'ID-12391' },
            'ID-12392': { name: 'Muhammad Haruman', nis: 'ID-12392' },
            'ID-12393': { name: 'Muhammad Husain Al-Idrus', nis: 'ID-12393' },
            'ID-12394': { name: 'Muhammad Husni Ajrif', nis: 'ID-12394' },
            'ID-12395': { name: 'Muhammad Ilham', nis: 'ID-12395' },
            'ID-12396': { name: 'Muhammad Marvel Khoirullah', nis: 'ID-12396' },
            'ID-12397': { name: 'Muhammad Muji Setiawan', nis: 'ID-12397' },
            'ID-12398': { name: 'Muhammad Nabil Fahrillah', nis: 'ID-12398' },
            'ID-12399': { name: 'Muhammad Nizar Firman', nis: 'ID-12399' },
            'ID-123100': { name: 'Muhammad Rauf Raihan', nis: 'ID-123100' },
            'ID-123101': { name: 'Muhammad Ridwan', nis: 'ID-123101' },
            'ID-123102': { name: 'Muhammad Sahlul Hikmah', nis: 'ID-123102' },
            'ID-123103': { name: 'Nabili Asyifa', nis: 'ID-123103' },
            'ID-123104': { name: 'Nuroniyah', nis: 'ID-123104' },
            'ID-123105': { name: 'Naufal Amrullah', nis: 'ID-123105' },
            'ID-123106': { name: 'Nurkholis', nis: 'ID-123106' },
            'ID-123107': { name: 'Radia Rifki A', nis: 'ID-123107' },
            'ID-123108': { name: 'Rafathul Qorib', nis: 'ID-123108' },
            'ID-123109': { name: 'Rafki Aditia', nis: 'ID-123109' },
            'ID-123110': { name: 'Rafki Setiawan', nis: 'ID-123110' },
            'ID-123111': { name: 'Rezky Wira Wicaksana', nis: 'ID-123111' },
            'ID-123112': { name: 'Ridho Surya', nis: 'ID-123112' },
            'ID-123113': { name: 'Rizik Karim', nis: 'ID-123113' },
            'ID-123114': { name: 'Rizkullah Alfiandu', nis: 'ID-123114' },
            'ID-123115': { name: 'Rizki Mukti', nis: 'ID-123115' },
            'ID-123116': { name: 'Satria Argya', nis: 'ID-123116' },
            'ID-123117': { name: 'Satrio Wiguna', nis: 'ID-123117' },
            'ID-123118': { name: 'Setya Adi Nugroho', nis: 'ID-123118' },
            'ID-123119': { name: 'Shihran Aqila Ardan', nis: 'ID-123119' },
            'ID-123120': { name: 'Sholahudin Ayub', nis: 'ID-123120' },
            'ID-123121': { name: 'Tubagus Muhammad Hasyim Al Muhtady', nis: 'ID-123121' },
            'ID-123122': { name: 'Wildan Ali Riyadi', nis: 'ID-123122' },
            'ID-123123': { name: 'Yuda Pratama', nis: 'ID-123123' },
            'ID-123124': { name: 'Zacky Ramadhan', nis: 'ID-123124' },
            'ID-123125': { name: 'Zahir Ali Kosasih', nis: 'ID-123125' },
            'ID-123126': { name: 'Zaki Riandy', nis: 'ID-123126' },
            'ID-123127': { name: 'Zaky Naufal Abdillah', nis: 'ID-123127' },
            'ID-123128': { name: 'Zidna Irfan Maulana Azrif', nis: 'ID-123128' },
            'ID-123129': { name: 'Muhammad Naufal Abdurrasyid', nis: 'ID-123129' },
            'ID-123130': { name: 'Muslim Pirza', nis: 'ID-123130' },
            'ID-123131': { name: 'Zidan Zafran', nis: 'ID-123131' },
            'ID-123132': { name: 'Bagus Putra Nur Dwi Wibowo', nis: 'ID-123132' },
            'ID-123133': { name: 'Muhammad Nafis Salim', nis: 'ID-123133' },
            'ID-123134': { name: 'Muhammad Khilmi', nis: 'ID-123134' },
            'ID-123': { name: 'Ade', nis: 'ID-123' },
        };

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('[id$="Page"]').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                document.getElementById('userInfo').textContent = `${user.name} (${user.role})`;
                showDashboard();
            } else {
                alert('Username atau password salah!');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('regRole').value;
            
            if (users.find(u => u.username === username)) {
                alert('Username sudah digunakan!');
                return;
            }
            
            const newUser = {
                username,
                password,
                role,
                name,
                registeredAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            // Send user data to spreadsheet
            sendUserToSpreadsheet(newUser);
            
            alert('Akun berhasil dibuat! Silakan login.');
            showPage('loginPage');
            document.getElementById('registerForm').reset();
        });

        // Show/Hide Register
        document.getElementById('showRegister').addEventListener('click', () => showPage('registerPage'));
        document.getElementById('showLogin').addEventListener('click', () => showPage('loginPage'));

        // Dashboard
        function showDashboard() {
            showPage('dashboardPage');
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadUsersList();
            } else if (currentUser.role === 'pengurus') {
                document.getElementById('activityPanel').classList.remove('hidden');
            }
            
            loadAttendanceRecords();
        }

        // Admin Panel
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            usersList.innerHTML = '';
            
            users.filter(u => u.role !== 'admin').forEach(user => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                row.innerHTML = `
                    <td class="px-4 py-3">${user.name}</td>
                    <td class="px-4 py-3">${user.username}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${user.role === 'pengurus' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-4 py-3">${new Date(user.registeredAt).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editUser('${user.username}')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600 transition duration-200">
                                Edit
                            </button>
                            <button onclick="deleteUser('${user.username}')" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600 transition duration-200">
                                Hapus
                            </button>
                        </div>
                    </td>
                `;
                usersList.appendChild(row);
            });
        }

        // Activity Selection
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectedActivity = this.dataset.activity;
                document.getElementById('selectedActivity').textContent = this.textContent.trim();
                document.getElementById('activityPanel').classList.add('hidden');
                document.getElementById('scannerPanel').classList.remove('hidden');
                startQRScanner();
            });
        });

        document.getElementById('backToActivity').addEventListener('click', function() {
            stopQRScanner();
            document.getElementById('scannerPanel').classList.add('hidden');
            document.getElementById('activityPanel').classList.remove('hidden');
            selectedActivity = null;
        });

        // QR Scanner
        function startQRScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText, decodedResult) => {
                    processQRCode(decodedText);
                },
                (errorMessage) => {
                    // Handle scan error silently
                }
            ).catch(err => {
                console.error("Error starting QR scanner:", err);
                alert("Tidak dapat mengakses kamera. Pastikan browser memiliki izin kamera.");
            });
        }

        function stopQRScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                }).catch(err => {
                    console.error("Error stopping QR scanner:", err);
                });
            }
        }

        function processQRCode(qrData) {
            const santri = santriData[qrData];
            const today = new Date().toDateString();
            const now = new Date();
            
            if (!santri) {
                showScanResult('QR Code tidak valid!', 'error');
                return;
            }
            
            // Check if already scanned for this activity today
            const existingRecord = attendanceData.find(record => 
                record.nis === santri.nis && 
                record.activity === selectedActivity && 
                new Date(record.timestamp).toDateString() === today
            );
            
            if (existingRecord) {
                showScanResult(`${santri.name} sudah absen untuk kegiatan ${selectedActivity} hari ini!`, 'warning');
                return;
            }
            
            // Add attendance record
            const attendanceRecord = {
                name: santri.name,
                nis: santri.nis,
                activity: selectedActivity,
                status: 'Hadir',
                timestamp: now.toISOString(),
                recordedBy: currentUser.name
            };
            
            attendanceData.push(attendanceRecord);
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            
            // Send to Google Spreadsheet
            sendToSpreadsheet(attendanceRecord);
            
            showScanResult(`âœ… ${santri.name} berhasil absen untuk ${selectedActivity}!`, 'success');
            loadAttendanceRecords();
        }

        function showScanResult(message, type) {
            const resultDiv = document.getElementById('scanResult');
            const messageDiv = document.getElementById('scanMessage');
            
            resultDiv.className = `mt-4 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 border border-green-300' :
                type === 'warning' ? 'bg-yellow-100 border border-yellow-300' :
                'bg-red-100 border border-red-300'
            }`;
            
            messageDiv.className = `text-center font-medium ${
                type === 'success' ? 'text-green-800' :
                type === 'warning' ? 'text-yellow-800' :
                'text-red-800'
            }`;
            
            messageDiv.textContent = message;
            resultDiv.classList.remove('hidden');
            
            setTimeout(() => {
                resultDiv.classList.add('hidden');
            }, 3000);
        }

        // Attendance Records
        function loadAttendanceRecords() {
            const attendanceList = document.getElementById('attendanceList');
            const today = new Date().toDateString();
            
            const todayRecords = attendanceData.filter(record => 
                new Date(record.timestamp).toDateString() === today
            );
            
            attendanceList.innerHTML = '';
            
            if (todayRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                        Belum ada data absensi hari ini
                    </td>
                `;
                attendanceList.appendChild(row);
                return;
            }
            
            todayRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                row.innerHTML = `
                    <td class="px-4 py-3">${record.name}</td>
                    <td class="px-4 py-3">${record.nis}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${record.activity}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            ${record.status}
                        </span>
                    </td>
                    <td class="px-4 py-3">${new Date(record.timestamp).toLocaleTimeString('id-ID')}</td>
                `;
                attendanceList.appendChild(row);
            });
        }

        // Google Spreadsheet Functions
        async function sendToSpreadsheet(data) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addAttendance',
                        data: data
                    })
                });
                
                console.log('Data berhasil dikirim ke spreadsheet');
            } catch (error) {
                console.error('Error mengirim data ke spreadsheet:', error);
                // Data tetap tersimpan lokal meskipun gagal kirim ke spreadsheet
            }
        }

        async function sendUserToSpreadsheet(userData) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addUser',
                        data: userData
                    })
                });
                
                console.log('Data user berhasil dikirim ke spreadsheet');
            } catch (error) {
                console.error('Error mengirim data user ke spreadsheet:', error);
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Yakin ingin logout?')) {
                stopQRScanner();
                currentUser = null;
                selectedActivity = null;
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('activityPanel').classList.add('hidden');
                document.getElementById('scannerPanel').classList.add('hidden');
                showPage('loginPage');
                document.getElementById('loginForm').reset();
            }
        });

        // User Management Functions
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editName').value = user.name;
            document.getElementById('editUsernameField').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = user.role;
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }

        function deleteUser(username) {
            if (confirm(`Yakin ingin menghapus user "${username}"?`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('users', JSON.stringify(users));
                loadUsersList();
                alert('User berhasil dihapus!');
            }
        }

        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('editUserForm').reset();
        }

        // Edit User Form Handler
        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const originalUsername = document.getElementById('editUsername').value;
            const newName = document.getElementById('editName').value;
            const newUsername = document.getElementById('editUsernameField').value;
            const newPassword = document.getElementById('editPassword').value;
            const newRole = document.getElementById('editRole').value;
            
            // Check if new username already exists (except for current user)
            if (newUsername !== originalUsername && users.find(u => u.username === newUsername)) {
                alert('Username sudah digunakan!');
                return;
            }
            
            // Find and update user
            const userIndex = users.findIndex(u => u.username === originalUsername);
            if (userIndex !== -1) {
                users[userIndex].name = newName;
                users[userIndex].username = newUsername;
                users[userIndex].role = newRole;
                
                // Update password only if provided
                if (newPassword.trim()) {
                    users[userIndex].password = newPassword;
                }
                
                localStorage.setItem('users', JSON.stringify(users));
                
                // Send updated user data to spreadsheet
                sendUserToSpreadsheet(users[userIndex]);
                
                closeEditModal();
                loadUsersList();
                alert('User berhasil diupdate!');
            }
        });

        // Initialize
        showPage('loginPage');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9718d0770759e783',t:'MTc1NTU5NzczNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
